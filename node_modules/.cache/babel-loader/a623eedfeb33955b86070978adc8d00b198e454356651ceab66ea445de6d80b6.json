{"ast":null,"code":"import _regeneratorRuntime from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _objectSpread from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _asyncToGenerator from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/es.regexp.exec.js\";\nimport \"core-js/modules/es.string.replace.js\";\nimport \"core-js/modules/es.date.to-string.js\";\nimport \"core-js/modules/web.timers.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.error.to-string.js\";\nimport Vue from \"vue\";\nimport Vuex from \"vuex\";\nimport { getUserRol } from \"@/services/users\";\nimport { signaturesSubscription } from \"@/services/signatures-service\";\nimport { Auth, Firestore, UsersDoc } from \"@/firebase-exports\";\nimport router from \"@/router\";\nVue.use(Vuex);\nexport default new Vuex.Store({\n  state: {\n    user: null\n  },\n  getters: {\n    isUserSignedIn: function isUserSignedIn(state) {\n      return !!state.user;\n    },\n    isUserAdmin: function isUserAdmin(state) {\n      if (state.user) {\n        return state.user.rol == \"admin\";\n      } else {\n        return false;\n      }\n    }\n  },\n  mutations: {\n    setUser: function setUser(state, user) {\n      state.user = user;\n    },\n    setVehicles: function setVehicles(state, vehicles) {\n      state.vehicles = vehicles;\n    }\n  },\n  actions: {\n    configureUser: function configureUser(_ref, data) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var commit, rol;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              commit = _ref.commit;\n              _context.next = 3;\n              return getUserRol();\n            case 3:\n              rol = _context.sent;\n              commit(\"setUser\", _objectSpread(_objectSpread({}, data), {}, {\n                rol: rol\n              }));\n            case 5:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee);\n      }))();\n    },\n    logout: function logout() {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return Auth.signOut(Auth.getAuth());\n            case 2:\n              router.replace(\"/login\");\n            case 3:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2);\n      }))();\n    },\n    // FetchUser\n    fetchUser: function fetchUser(_ref2) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee5() {\n        var dispatch, firebaseUser, userUnsubscribe;\n        return _regeneratorRuntime().wrap(function _callee5$(_context5) {\n          while (1) switch (_context5.prev = _context5.next) {\n            case 0:\n              dispatch = _ref2.dispatch;\n              _context5.prev = 1;\n              _context5.next = 4;\n              return Auth.getAuth().currentUser;\n            case 4:\n              firebaseUser = _context5.sent;\n              Auth.getAuth().currentUser.getIdToken(false);\n              if (!firebaseUser) {\n                _context5.next = 11;\n                break;\n              }\n              userUnsubscribe = Firestore.onSnapshot(UsersDoc(firebaseUser.uid), /*#__PURE__*/function () {\n                var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4(docSnap) {\n                  var firestoreUser, firestoreCopy, tokenExpiration, currentDate, expirationTimeout;\n                  return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n                    while (1) switch (_context4.prev = _context4.next) {\n                      case 0:\n                        firestoreUser = docSnap.data();\n                        firestoreCopy = _objectSpread(_objectSpread({}, firestoreUser), {}, {\n                          id: firebaseUser.uid\n                        });\n                        dispatch(\"configureUser\", firestoreCopy);\n                        _context4.next = 5;\n                        return vehiclesSubscription(firebaseUser.uid);\n                      case 5:\n                        firestoreUser.id = firebaseUser.uid;\n                        tokenExpiration = firebaseUser.stsTokenManager.expirationTime;\n                        currentDate = new Date().getTime();\n                        expirationTimeout = tokenExpiration - currentDate;\n                        setTimeout( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {\n                          return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n                            while (1) switch (_context3.prev = _context3.next) {\n                              case 0:\n                                _context3.next = 2;\n                                return dispatch(\"fetchUser\");\n                              case 2:\n                              case \"end\":\n                                return _context3.stop();\n                            }\n                          }, _callee3);\n                        })), expirationTimeout);\n                        if (!router.currentRoute.meta.userCanAccess()) {\n                          router.push(\"/login\");\n                        }\n                      case 11:\n                      case \"end\":\n                        return _context4.stop();\n                    }\n                  }, _callee4);\n                }));\n                return function (_x) {\n                  return _ref3.apply(this, arguments);\n                };\n              }(), function (error) {\n                throw error;\n              });\n              return _context5.abrupt(\"return\", userUnsubscribe);\n            case 11:\n              throw new Error(\"User is not authenticated\");\n            case 12:\n              _context5.next = 18;\n              break;\n            case 14:\n              _context5.prev = 14;\n              _context5.t0 = _context5[\"catch\"](1);\n              dispatch(\"configureUser\", null);\n              throw _context5.t0;\n            case 18:\n            case \"end\":\n              return _context5.stop();\n          }\n        }, _callee5, null, [[1, 14]]);\n      }))();\n    }\n  },\n  modules: {}\n});","map":{"version":3,"names":["Vue","Vuex","getUserRol","signaturesSubscription","Auth","Firestore","UsersDoc","router","use","Store","state","user","getters","isUserSignedIn","isUserAdmin","rol","mutations","setUser","setVehicles","vehicles","actions","configureUser","_ref","data","_asyncToGenerator","_regeneratorRuntime","mark","_callee","commit","wrap","_callee$","_context","prev","next","sent","_objectSpread","stop","logout","_callee2","_callee2$","_context2","signOut","getAuth","replace","fetchUser","_ref2","_callee5","dispatch","firebaseUser","userUnsubscribe","_callee5$","_context5","currentUser","getIdToken","onSnapshot","uid","_ref3","_callee4","docSnap","firestoreUser","firestoreCopy","tokenExpiration","currentDate","expirationTimeout","_callee4$","_context4","id","vehiclesSubscription","stsTokenManager","expirationTime","Date","getTime","setTimeout","_callee3","_callee3$","_context3","currentRoute","meta","userCanAccess","push","_x","apply","arguments","error","abrupt","Error","t0","modules"],"sources":["/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/src/store/index.js"],"sourcesContent":["import Vue from \"vue\";\nimport Vuex from \"vuex\";\nimport { getUserRol } from \"@/services/users\";\nimport { signaturesSubscription } from \"@/services/signatures-service\";\n\nimport { Auth, Firestore, UsersDoc } from \"@/firebase-exports\";\n\nimport router from \"@/router\";\n\nVue.use(Vuex);\n\nexport default new Vuex.Store({\n  state: {\n    user: null,\n  },\n  getters: {\n    isUserSignedIn(state) {\n      return !!state.user;\n    },\n    isUserAdmin(state) {\n      if (state.user) {\n        return state.user.rol == \"admin\";\n      } else {\n        return false;\n      }\n    },\n  },\n  mutations: {\n    setUser(state, user) {\n      state.user = user;\n    },\n    setVehicles(state, vehicles) {\n      state.vehicles = vehicles;\n    },\n  },\n  actions: {\n    async configureUser({ commit }, data) {\n      const rol = await getUserRol();\n      commit(\"setUser\", { ...data, rol });\n    },\n    async logout() {\n      await Auth.signOut(Auth.getAuth());\n      router.replace(\"/login\");\n    },\n    // FetchUser\n    async fetchUser({ dispatch }) {\n      try {\n        const firebaseUser = await Auth.getAuth().currentUser;\n        Auth.getAuth().currentUser.getIdToken(false);\n        if (firebaseUser) {\n          var userUnsubscribe = Firestore.onSnapshot(\n            UsersDoc(firebaseUser.uid),\n            async (docSnap) => {\n              var firestoreUser = docSnap.data();\n              var firestoreCopy = {\n                ...firestoreUser,\n                id: firebaseUser.uid,\n              };\n              dispatch(\"configureUser\", firestoreCopy);\n\n              await vehiclesSubscription(firebaseUser.uid);\n\n              firestoreUser.id = firebaseUser.uid;\n              const tokenExpiration =\n                firebaseUser.stsTokenManager.expirationTime;\n              const currentDate = new Date().getTime();\n              const expirationTimeout = tokenExpiration - currentDate;\n              setTimeout(async () => {\n                await dispatch(\"fetchUser\");\n              }, expirationTimeout);\n              if (!router.currentRoute.meta.userCanAccess()) {\n                router.push(\"/login\");\n              }\n            },\n            (error) => {\n              throw error;\n            }\n          );\n          return userUnsubscribe;\n        } else {\n          throw new Error(\"User is not authenticated\");\n        }\n      } catch (err) {\n        dispatch(\"configureUser\", null);\n        throw err;\n      }\n    },\n  },\n  modules: {},\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}