{"ast":null,"code":"import _objectSpread from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _regeneratorRuntime from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/es.date.to-string.js\";\nimport \"core-js/modules/web.timers.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.error.to-string.js\";\nimport Vue from \"vue\";\nimport Vuex from \"vuex\";\nimport { getUserRol } from \"@/services/users\";\nVue.use(Vuex);\nexport default new Vuex.Store({\n  state: {\n    user: null\n  },\n  getters: {\n    isUserSignedIn: function isUserSignedIn(state) {\n      return !!state.user;\n    },\n    isUserAdmin: function isUserAdmin(state) {\n      if (state.user) {\n        return state.user.rol == \"admin\";\n      } else {\n        return false;\n      }\n    }\n  },\n  mutations: {\n    setUser: function setUser(state, user) {\n      state.user = user;\n    }\n  },\n  actions: {\n    configureUser: function configureUser(_ref, username) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var commit, rol;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              commit = _ref.commit;\n              _context.next = 3;\n              return getUserRol();\n            case 3:\n              rol = _context.sent;\n              commit(\"setUser\", {\n                username: username,\n                rol: rol\n              });\n            case 5:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee);\n      }))();\n    },\n    fetchUser: function fetchUser(_ref2) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4() {\n        var dispatch, commit, firebaseUser, userUnsubscribe;\n        return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n          while (1) switch (_context4.prev = _context4.next) {\n            case 0:\n              dispatch = _ref2.dispatch, commit = _ref2.commit;\n              _context4.prev = 1;\n              _context4.next = 4;\n              return Auth.getAuth().currentUser;\n            case 4:\n              firebaseUser = _context4.sent;\n              Auth.getAuth().currentUser.getIdToken(false);\n              if (!firebaseUser) {\n                _context4.next = 11;\n                break;\n              }\n              userUnsubscribe = Firestore.onSnapshot(UsersDoc(firebaseUser.uid), /*#__PURE__*/function () {\n                var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3(docSnap) {\n                  var firestoreUser, firestoreCopy, tokenExpiration, currentDate, expirationTimeout;\n                  return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n                    while (1) switch (_context3.prev = _context3.next) {\n                      case 0:\n                        firestoreUser = docSnap.data();\n                        firestoreCopy = _objectSpread(_objectSpread({}, firestoreUser), {}, {\n                          id: firebaseUser.uid\n                        });\n                        dispatch(\"configureUser\", firestoreCopy);\n                        firestoreUser.id = firebaseUser.uid;\n                        tokenExpiration = firebaseUser.stsTokenManager.expirationTime;\n                        currentDate = new Date().getTime();\n                        expirationTimeout = tokenExpiration - currentDate;\n                        setTimeout( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n                          return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n                            while (1) switch (_context2.prev = _context2.next) {\n                              case 0:\n                                _context2.next = 2;\n                                return dispatch(\"fetchUser\");\n                              case 2:\n                              case \"end\":\n                                return _context2.stop();\n                            }\n                          }, _callee2);\n                        })), expirationTimeout);\n                        if (!router.currentRoute.meta.userCanAccess()) {\n                          router.push(\"/\");\n                        }\n\n                        // Suscripción de las noticias\n                        if (!(!store.getters.isDemoEnv && !store.getters.isAddaliaUser)) {\n                          _context3.next = 12;\n                          break;\n                        }\n                        _context3.next = 12;\n                        return newsSubscription();\n                      case 12:\n                      case \"end\":\n                        return _context3.stop();\n                    }\n                  }, _callee3);\n                }));\n                return function (_x) {\n                  return _ref3.apply(this, arguments);\n                };\n              }(), function (error) {\n                throw error;\n              });\n              return _context4.abrupt(\"return\", userUnsubscribe);\n            case 11:\n              throw new Error(\"User is not authenticated\");\n            case 12:\n              _context4.next = 18;\n              break;\n            case 14:\n              _context4.prev = 14;\n              _context4.t0 = _context4[\"catch\"](1);\n              dispatch(\"configureUser\", null);\n              throw _context4.t0;\n            case 18:\n            case \"end\":\n              return _context4.stop();\n          }\n        }, _callee4, null, [[1, 14]]);\n      }))();\n    }\n  },\n  modules: {}\n});","map":{"version":3,"names":["Vue","Vuex","getUserRol","use","Store","state","user","getters","isUserSignedIn","isUserAdmin","rol","mutations","setUser","actions","configureUser","_ref","username","_asyncToGenerator","_regeneratorRuntime","mark","_callee","commit","wrap","_callee$","_context","prev","next","sent","stop","fetchUser","_ref2","_callee4","dispatch","firebaseUser","userUnsubscribe","_callee4$","_context4","Auth","getAuth","currentUser","getIdToken","Firestore","onSnapshot","UsersDoc","uid","_ref3","_callee3","docSnap","firestoreUser","firestoreCopy","tokenExpiration","currentDate","expirationTimeout","_callee3$","_context3","data","_objectSpread","id","stsTokenManager","expirationTime","Date","getTime","setTimeout","_callee2","_callee2$","_context2","router","currentRoute","meta","userCanAccess","push","store","isDemoEnv","isAddaliaUser","newsSubscription","_x","apply","arguments","error","abrupt","Error","t0","modules"],"sources":["/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/src/store/index.js"],"sourcesContent":["import Vue from \"vue\";\nimport Vuex from \"vuex\";\nimport { getUserRol } from \"@/services/users\";\nVue.use(Vuex);\n\nexport default new Vuex.Store({\n  state: {\n    user: null,\n  },\n  getters: {\n    isUserSignedIn(state) {\n      return !!state.user;\n    },\n    isUserAdmin(state) {\n      if (state.user) {\n        return state.user.rol == \"admin\";\n      } else {\n        return false;\n      }\n    },\n  },\n  mutations: {\n    setUser(state, user) {\n      state.user = user;\n    },\n  },\n  actions: {\n    async configureUser({ commit }, username) {\n      const rol = await getUserRol();\n      commit(\"setUser\", { username: username, rol: rol });\n    },\n    async fetchUser({ dispatch, commit }) {\n      try {\n        const firebaseUser = await Auth.getAuth().currentUser;\n        Auth.getAuth().currentUser.getIdToken(false);\n        if (firebaseUser) {\n          var userUnsubscribe = Firestore.onSnapshot(\n            UsersDoc(firebaseUser.uid),\n            async (docSnap) => {\n              var firestoreUser = docSnap.data();\n              var firestoreCopy = {\n                ...firestoreUser,\n                id: firebaseUser.uid,\n              };\n              dispatch(\"configureUser\", firestoreCopy);\n\n              firestoreUser.id = firebaseUser.uid;\n              const tokenExpiration =\n                firebaseUser.stsTokenManager.expirationTime;\n              const currentDate = new Date().getTime();\n              const expirationTimeout = tokenExpiration - currentDate;\n              setTimeout(async () => {\n                await dispatch(\"fetchUser\");\n              }, expirationTimeout);\n              if (!router.currentRoute.meta.userCanAccess()) {\n                router.push(\"/\");\n              }\n\n              // Suscripción de las noticias\n              if (!store.getters.isDemoEnv && !store.getters.isAddaliaUser)\n                await newsSubscription();\n            },\n            (error) => {\n              throw error;\n            }\n          );\n          return userUnsubscribe;\n        } else {\n          throw new Error(\"User is not authenticated\");\n        }\n      } catch (err) {\n        dispatch(\"configureUser\", null);\n        throw err;\n      }\n    },\n  },\n  modules: {},\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}