{"ast":null,"code":"import _objectSpread from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _regeneratorRuntime from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/es.date.now.js\";\nimport \"core-js/modules/es.date.to-string.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/web.timers.js\";\nimport \"core-js/modules/es.function.name.js\";\nimport \"core-js/modules/es.regexp.exec.js\";\nimport \"core-js/modules/es.string.replace.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport { mapActions } from \"vuex\";\nimport { Auth } from \"@/firebase-exports\";\nexport default {\n  data: function data() {\n    return {\n      username: \"\",\n      password: \"\"\n    };\n  },\n  beforeCreate: function beforeCreate() {\n    var _this = this;\n    return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n      return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n        while (1) switch (_context2.prev = _context2.next) {\n          case 0:\n            Auth.onAuthStateChanged(Auth.getAuth(), /*#__PURE__*/function () {\n              var _ref = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee(user) {\n                var authTime, sessionDuration, finalRoute;\n                return _regeneratorRuntime().wrap(function _callee$(_context) {\n                  while (1) switch (_context.prev = _context.next) {\n                    case 0:\n                      if (!user) {\n                        _context.next = 28;\n                        break;\n                      }\n                      _context.prev = 1;\n                      _context.next = 4;\n                      return user.getIdTokenResult();\n                    case 4:\n                      _context.t0 = _context.sent.claims.auth_time;\n                      authTime = _context.t0 * 1000;\n                      // Establecemos el tiempo de sesion\n                      sessionDuration = 1000 * 60 * 60 * 12; // 12 hour session\n                      // En el caso de se expire la sesión llamamos a la función de expireSession de methods\n                      if (!(Date.now() > authTime + sessionDuration)) {\n                        _context.next = 12;\n                        break;\n                      }\n                      _context.next = 10;\n                      return _this.expireSession();\n                    case 10:\n                      _context.next = 18;\n                      break;\n                    case 12:\n                      _context.next = 14;\n                      return _this.fetchUser();\n                    case 14:\n                      _this.userUnsubscribe = _context.sent;\n                      _context.next = 17;\n                      return new Promise(function (resolve) {\n                        return setTimeout(resolve, 2000);\n                      });\n                    case 17:\n                      // En el caso de que este todo correcto, redirigimos al usuario a la pagina '/home'\n                      if (_this.$route.name === \"LoginView\" || _this.$route.fullPath === \"/login\") {\n                        finalRoute = _this.$route.query.redirect || \"/home\";\n                        _this.$router.replace(finalRoute);\n                      }\n                    case 18:\n                      _context.next = 26;\n                      break;\n                    case 20:\n                      _context.prev = 20;\n                      _context.t1 = _context[\"catch\"](1);\n                      console.log(_this.$t(\"genericError\"));\n                      _context.next = 25;\n                      return new Promise(function (resolve) {\n                        return setTimeout(resolve, 3000);\n                      });\n                    case 25:\n                      _this.logout();\n                    case 26:\n                      _context.next = 29;\n                      break;\n                    case 28:\n                      _this.userUnsubscribe();\n                    case 29:\n                    case \"end\":\n                      return _context.stop();\n                  }\n                }, _callee, null, [[1, 20]]);\n              }));\n              return function (_x) {\n                return _ref.apply(this, arguments);\n              };\n            }());\n          case 1:\n          case \"end\":\n            return _context2.stop();\n        }\n      }, _callee2);\n    }))();\n  },\n  methods: _objectSpread(_objectSpread({}, mapActions([\"configureUser\", \"fetchUser\", \"logout\"])), {}, {\n    login: function login() {\n      var _this2 = this;\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee5() {\n        var _yield$Auth$signInWit, user;\n        return _regeneratorRuntime().wrap(function _callee5$(_context5) {\n          while (1) switch (_context5.prev = _context5.next) {\n            case 0:\n              if (!(!token && !_this2.$refs.loginForm.validate())) {\n                _context5.next = 2;\n                break;\n              }\n              return _context5.abrupt(\"return\");\n            case 2:\n              _this2.loading = true;\n              _context5.prev = 3;\n              _context5.next = 6;\n              return Auth.signInWithEmailAndPassword(_this2.authData, token ? token.username : _this2.username, token ? token.password : _this2.password);\n            case 6:\n              _yield$Auth$signInWit = _context5.sent;\n              user = _yield$Auth$signInWit.user;\n              getIp().then( /*#__PURE__*/function () {\n                var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3(ip) {\n                  return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n                    while (1) switch (_context3.prev = _context3.next) {\n                      case 0:\n                        _context3.next = 2;\n                        return createTrace(user.uid, {\n                          actionType: \"logged\",\n                          createdAt: new Date(),\n                          ip: ip\n                        });\n                      case 2:\n                      case \"end\":\n                        return _context3.stop();\n                    }\n                  }, _callee3);\n                }));\n                return function (_x2) {\n                  return _ref2.apply(this, arguments);\n                };\n              }())[\"catch\"]( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4() {\n                return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n                  while (1) switch (_context4.prev = _context4.next) {\n                    case 0:\n                      _context4.next = 2;\n                      return createTrace(user.uid, {\n                        actionType: \"logged\",\n                        createdAt: new Date()\n                      });\n                    case 2:\n                    case \"end\":\n                      return _context4.stop();\n                  }\n                }, _callee4);\n              })));\n              _context5.next = 14;\n              break;\n            case 11:\n              _context5.prev = 11;\n              _context5.t0 = _context5[\"catch\"](3);\n              console.log(_context5.t0);\n            case 14:\n              _context5.next = 16;\n              return _this2.configureUser(_this2.username);\n            case 16:\n              _this2.$router.push({\n                name: \"home\"\n              });\n            case 17:\n            case \"end\":\n              return _context5.stop();\n          }\n        }, _callee5, null, [[3, 11]]);\n      }))();\n    },\n    userUnsubscribe: function userUnsubscribe() {},\n    expireSession: function expireSession() {\n      var _this3 = this;\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee6() {\n        return _regeneratorRuntime().wrap(function _callee6$(_context6) {\n          while (1) switch (_context6.prev = _context6.next) {\n            case 0:\n              _context6.next = 2;\n              return _this3.logout();\n            case 2:\n              _this3.$router.push({\n                name: \"LoginView\"\n              });\n            case 3:\n            case \"end\":\n              return _context6.stop();\n          }\n        }, _callee6);\n      }))();\n    } // clearSessionTimeOut() {\n    //   if (this.timeOut) {\n    //     clearInterval(this.timeOut);\n    //     this.timeOut = null;\n    //   }\n    // },\n  })\n};","map":{"version":3,"names":["mapActions","Auth","data","username","password","beforeCreate","_this","_asyncToGenerator","_regeneratorRuntime","mark","_callee2","wrap","_callee2$","_context2","prev","next","onAuthStateChanged","getAuth","_ref","_callee","user","authTime","sessionDuration","finalRoute","_callee$","_context","getIdTokenResult","t0","sent","claims","auth_time","Date","now","expireSession","fetchUser","userUnsubscribe","Promise","resolve","setTimeout","$route","name","fullPath","query","redirect","$router","replace","t1","console","log","$t","logout","stop","_x","apply","arguments","methods","_objectSpread","login","_this2","_callee5","_yield$Auth$signInWit","_callee5$","_context5","token","$refs","loginForm","validate","abrupt","loading","signInWithEmailAndPassword","authData","getIp","then","_ref2","_callee3","ip","_callee3$","_context3","createTrace","uid","actionType","createdAt","_x2","_callee4","_callee4$","_context4","configureUser","push","_this3","_callee6","_callee6$","_context6"],"sources":["src/components/login/LoginCard.vue"],"sourcesContent":["<template>\r\n  <div>\r\n    <h2>Iniciar sesión</h2>\r\n    <form @submit.prevent=\"login\">\r\n      <div>\r\n        <label for=\"username\">Usuario:</label>\r\n        <input type=\"text\" id=\"username\" v-model=\"username\" required />\r\n      </div>\r\n      <div>\r\n        <label for=\"password\">Contraseña:</label>\r\n        <input type=\"password\" id=\"password\" v-model=\"password\" required />\r\n      </div>\r\n      <button @click=\"login()\" type=\"submit\">Iniciar sesión</button>\r\n    </form>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport { mapActions } from \"vuex\";\r\nimport { Auth } from \"@/firebase-exports\";\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      username: \"\",\r\n      password: \"\",\r\n    };\r\n  },\r\n  async beforeCreate() {\r\n    Auth.onAuthStateChanged(Auth.getAuth(), async (user) => {\r\n      if (user) {\r\n        try {\r\n          // Establecemos el tiempo de autenticación\r\n          const authTime =\r\n            (await user.getIdTokenResult()).claims.auth_time * 1000;\r\n\r\n          // Establecemos el tiempo de sesion\r\n          const sessionDuration = 1000 * 60 * 60 * 12; // 12 hour session\r\n\r\n          // En el caso de se expire la sesión llamamos a la función de expireSession de methods\r\n          if (Date.now() > authTime + sessionDuration)\r\n            await this.expireSession();\r\n          else {\r\n            // const remaining = authTime + sessionDuration - Date.now();\r\n            // const twoHours = 1000 * 60 * 60 * 2;\r\n            // this.setSessionTimeOut(remaining > twoHours ? remaining : twoHours);\r\n\r\n            // Suscripcion del usuario\r\n            this.userUnsubscribe = await this.fetchUser();\r\n            await new Promise((resolve) => setTimeout(resolve, 2000));\r\n\r\n            // En el caso de que este todo correcto, redirigimos al usuario a la pagina '/home'\r\n            if (\r\n              this.$route.name === \"LoginView\" ||\r\n              this.$route.fullPath === \"/login\"\r\n            ) {\r\n              const finalRoute = this.$route.query.redirect || \"/home\";\r\n              this.$router.replace(finalRoute);\r\n            }\r\n          }\r\n        } catch {\r\n          console.log(this.$t(\"genericError\"));\r\n\r\n          await new Promise((resolve) => setTimeout(resolve, 3000));\r\n          this.logout();\r\n        }\r\n      } else {\r\n        this.userUnsubscribe();\r\n      }\r\n    });\r\n  },\r\n  methods: {\r\n    ...mapActions([\"configureUser\", \"fetchUser\", \"logout\"]),\r\n    async login() {\r\n      if (!token && !this.$refs.loginForm.validate()) return;\r\n\r\n      this.loading = true;\r\n\r\n      try {\r\n        const { user } = await Auth.signInWithEmailAndPassword(\r\n          this.authData,\r\n          token ? token.username : this.username,\r\n          token ? token.password : this.password\r\n        );\r\n\r\n        getIp()\r\n          .then(async (ip) => {\r\n            await createTrace(user.uid, {\r\n              actionType: \"logged\",\r\n              createdAt: new Date(),\r\n              ip,\r\n            });\r\n          })\r\n          .catch(async () => {\r\n            await createTrace(user.uid, {\r\n              actionType: \"logged\",\r\n              createdAt: new Date(),\r\n            });\r\n          });\r\n      } catch (err) {\r\n        console.log(err);\r\n      }\r\n      await this.configureUser(this.username);\r\n      this.$router.push({ name: \"home\" });\r\n    },\r\n    userUnsubscribe() {},\r\n    async expireSession() {\r\n      await this.logout();\r\n      this.$router.push({ name: \"LoginView\" });\r\n    },\r\n    // clearSessionTimeOut() {\r\n    //   if (this.timeOut) {\r\n    //     clearInterval(this.timeOut);\r\n    //     this.timeOut = null;\r\n    //   }\r\n    // },\r\n  },\r\n};\r\n</script>\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}