{"ast":null,"code":"import _objectSpread from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _regeneratorRuntime from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/es.date.to-string.js\";\nimport \"core-js/modules/web.timers.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.error.to-string.js\";\nimport Vue from \"vue\";\nimport Vuex from \"vuex\";\nimport { getUserRol } from \"@/services/users\";\nimport { Auth, Firestore, UsersDoc } from \"@/firebase-exports\";\nimport router from \"@/router\";\nVue.use(Vuex);\nexport default new Vuex.Store({\n  state: {\n    user: null\n  },\n  getters: {\n    isUserSignedIn: function isUserSignedIn(state) {\n      return !!state.user;\n    },\n    isUserAdmin: function isUserAdmin(state) {\n      if (state.user) {\n        return state.user.rol == \"admin\";\n      } else {\n        return false;\n      }\n    }\n  },\n  mutations: {\n    setUser: function setUser(state, user) {\n      state.user = user;\n    }\n  },\n  actions: {\n    configureUser: function configureUser(_ref, username) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var commit, rol;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              commit = _ref.commit;\n              _context.next = 3;\n              return getUserRol();\n            case 3:\n              rol = _context.sent;\n              commit(\"setUser\", {\n                username: username,\n                rol: rol\n              });\n            case 5:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee);\n      }))();\n    },\n    // FetchUser\n    fetchUser: function fetchUser(_ref2) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4() {\n        var dispatch, firebaseUser, userUnsubscribe;\n        return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n          while (1) switch (_context4.prev = _context4.next) {\n            case 0:\n              dispatch = _ref2.dispatch;\n              _context4.prev = 1;\n              _context4.next = 4;\n              return Auth.getAuth().currentUser;\n            case 4:\n              firebaseUser = _context4.sent;\n              Auth.getAuth().currentUser.getIdToken(false);\n              if (!firebaseUser) {\n                _context4.next = 11;\n                break;\n              }\n              userUnsubscribe = Firestore.onSnapshot(UsersDoc(firebaseUser.uid), /*#__PURE__*/function () {\n                var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3(docSnap) {\n                  var firestoreUser, firestoreCopy, tokenExpiration, currentDate, expirationTimeout;\n                  return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n                    while (1) switch (_context3.prev = _context3.next) {\n                      case 0:\n                        firestoreUser = docSnap.data();\n                        firestoreCopy = _objectSpread(_objectSpread({}, firestoreUser), {}, {\n                          id: firebaseUser.uid\n                        });\n                        dispatch(\"configureUser\", firestoreCopy);\n                        firestoreUser.id = firebaseUser.uid;\n                        tokenExpiration = firebaseUser.stsTokenManager.expirationTime;\n                        currentDate = new Date().getTime();\n                        expirationTimeout = tokenExpiration - currentDate;\n                        setTimeout( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n                          return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n                            while (1) switch (_context2.prev = _context2.next) {\n                              case 0:\n                                _context2.next = 2;\n                                return dispatch(\"fetchUser\");\n                              case 2:\n                              case \"end\":\n                                return _context2.stop();\n                            }\n                          }, _callee2);\n                        })), expirationTimeout);\n                        if (!router.currentRoute.meta.userCanAccess()) {\n                          router.push(\"/login\");\n                        }\n                      case 9:\n                      case \"end\":\n                        return _context3.stop();\n                    }\n                  }, _callee3);\n                }));\n                return function (_x) {\n                  return _ref3.apply(this, arguments);\n                };\n              }(), function (error) {\n                throw error;\n              });\n              return _context4.abrupt(\"return\", userUnsubscribe);\n            case 11:\n              throw new Error(\"User is not authenticated\");\n            case 12:\n              _context4.next = 18;\n              break;\n            case 14:\n              _context4.prev = 14;\n              _context4.t0 = _context4[\"catch\"](1);\n              dispatch(\"configureUser\", null);\n              throw _context4.t0;\n            case 18:\n            case \"end\":\n              return _context4.stop();\n          }\n        }, _callee4, null, [[1, 14]]);\n      }))();\n    }\n  },\n  modules: {}\n});","map":{"version":3,"names":["Vue","Vuex","getUserRol","Auth","Firestore","UsersDoc","router","use","Store","state","user","getters","isUserSignedIn","isUserAdmin","rol","mutations","setUser","actions","configureUser","_ref","username","_asyncToGenerator","_regeneratorRuntime","mark","_callee","commit","wrap","_callee$","_context","prev","next","sent","stop","fetchUser","_ref2","_callee4","dispatch","firebaseUser","userUnsubscribe","_callee4$","_context4","getAuth","currentUser","getIdToken","onSnapshot","uid","_ref3","_callee3","docSnap","firestoreUser","firestoreCopy","tokenExpiration","currentDate","expirationTimeout","_callee3$","_context3","data","_objectSpread","id","stsTokenManager","expirationTime","Date","getTime","setTimeout","_callee2","_callee2$","_context2","currentRoute","meta","userCanAccess","push","_x","apply","arguments","error","abrupt","Error","t0","modules"],"sources":["/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/src/store/index.js"],"sourcesContent":["import Vue from \"vue\";\nimport Vuex from \"vuex\";\nimport { getUserRol } from \"@/services/users\";\nimport { Auth, Firestore, UsersDoc } from \"@/firebase-exports\";\n\nimport router from \"@/router\";\n\nVue.use(Vuex);\n\nexport default new Vuex.Store({\n  state: {\n    user: null,\n  },\n  getters: {\n    isUserSignedIn(state) {\n      return !!state.user;\n    },\n    isUserAdmin(state) {\n      if (state.user) {\n        return state.user.rol == \"admin\";\n      } else {\n        return false;\n      }\n    },\n  },\n  mutations: {\n    setUser(state, user) {\n      state.user = user;\n    },\n  },\n  actions: {\n    async configureUser({ commit }, username) {\n      const rol = await getUserRol();\n      commit(\"setUser\", { username: username, rol: rol });\n    },\n    // FetchUser\n    async fetchUser({ dispatch }) {\n      try {\n        const firebaseUser = await Auth.getAuth().currentUser;\n        Auth.getAuth().currentUser.getIdToken(false);\n        if (firebaseUser) {\n          var userUnsubscribe = Firestore.onSnapshot(\n            UsersDoc(firebaseUser.uid),\n            async (docSnap) => {\n              var firestoreUser = docSnap.data();\n              var firestoreCopy = {\n                ...firestoreUser,\n                id: firebaseUser.uid,\n              };\n              dispatch(\"configureUser\", firestoreCopy);\n\n              firestoreUser.id = firebaseUser.uid;\n              const tokenExpiration =\n                firebaseUser.stsTokenManager.expirationTime;\n              const currentDate = new Date().getTime();\n              const expirationTimeout = tokenExpiration - currentDate;\n              setTimeout(async () => {\n                await dispatch(\"fetchUser\");\n              }, expirationTimeout);\n              if (!router.currentRoute.meta.userCanAccess()) {\n                router.push(\"/login\");\n              }\n            },\n            (error) => {\n              throw error;\n            }\n          );\n          return userUnsubscribe;\n        } else {\n          throw new Error(\"User is not authenticated\");\n        }\n      } catch (err) {\n        dispatch(\"configureUser\", null);\n        throw err;\n      }\n    },\n  },\n  modules: {},\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}