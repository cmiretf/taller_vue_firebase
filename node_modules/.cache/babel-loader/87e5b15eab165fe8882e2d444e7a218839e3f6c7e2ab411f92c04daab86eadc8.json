{"ast":null,"code":"import _objectSpread from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _regeneratorRuntime from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/regeneratorRuntime.js\";\nimport _asyncToGenerator from \"/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport \"core-js/modules/es.regexp.exec.js\";\nimport \"core-js/modules/es.string.replace.js\";\nimport \"core-js/modules/es.date.to-string.js\";\nimport \"core-js/modules/web.timers.js\";\nimport \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.error.cause.js\";\nimport \"core-js/modules/es.error.to-string.js\";\nimport Vue from \"vue\";\nimport Vuex from \"vuex\";\nimport { getUserRol } from \"@/services/users\";\nimport { Auth, Firestore, UsersDoc } from \"@/firebase-exports\";\nimport router from \"@/router\";\nVue.use(Vuex);\nexport default new Vuex.Store({\n  state: {\n    user: null\n  },\n  getters: {\n    isUserSignedIn: function isUserSignedIn(state) {\n      return !!state.user;\n    },\n    isUserAdmin: function isUserAdmin(state) {\n      if (state.user) {\n        return state.user.rol == \"admin\";\n      } else {\n        return false;\n      }\n    }\n  },\n  mutations: {\n    setUser: function setUser(state, user) {\n      state.user = user;\n    }\n  },\n  actions: {\n    configureUser: function configureUser(_ref, username) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee() {\n        var commit, rol;\n        return _regeneratorRuntime().wrap(function _callee$(_context) {\n          while (1) switch (_context.prev = _context.next) {\n            case 0:\n              commit = _ref.commit;\n              _context.next = 3;\n              return getUserRol();\n            case 3:\n              rol = _context.sent;\n              commit(\"setUser\", {\n                username: username,\n                rol: rol\n              });\n            case 5:\n            case \"end\":\n              return _context.stop();\n          }\n        }, _callee);\n      }))();\n    },\n    logout: function logout(_ref2) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee2() {\n        var dispatch;\n        return _regeneratorRuntime().wrap(function _callee2$(_context2) {\n          while (1) switch (_context2.prev = _context2.next) {\n            case 0:\n              dispatch = _ref2.dispatch;\n              _context2.next = 3;\n              return Auth.signOut(Auth.getAuth());\n            case 3:\n              router.replace(\"/login\");\n            case 4:\n            case \"end\":\n              return _context2.stop();\n          }\n        }, _callee2);\n      }))();\n    },\n    // FetchUser\n    fetchUser: function fetchUser(_ref3) {\n      return _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee5() {\n        var dispatch, firebaseUser, userUnsubscribe;\n        return _regeneratorRuntime().wrap(function _callee5$(_context5) {\n          while (1) switch (_context5.prev = _context5.next) {\n            case 0:\n              dispatch = _ref3.dispatch;\n              _context5.prev = 1;\n              _context5.next = 4;\n              return Auth.getAuth().currentUser;\n            case 4:\n              firebaseUser = _context5.sent;\n              Auth.getAuth().currentUser.getIdToken(false);\n              if (!firebaseUser) {\n                _context5.next = 11;\n                break;\n              }\n              userUnsubscribe = Firestore.onSnapshot(UsersDoc(firebaseUser.uid), /*#__PURE__*/function () {\n                var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee4(docSnap) {\n                  var firestoreUser, firestoreCopy, tokenExpiration, currentDate, expirationTimeout;\n                  return _regeneratorRuntime().wrap(function _callee4$(_context4) {\n                    while (1) switch (_context4.prev = _context4.next) {\n                      case 0:\n                        firestoreUser = docSnap.data();\n                        firestoreCopy = _objectSpread(_objectSpread({}, firestoreUser), {}, {\n                          id: firebaseUser.uid\n                        });\n                        dispatch(\"configureUser\", firestoreCopy);\n                        firestoreUser.id = firebaseUser.uid;\n                        tokenExpiration = firebaseUser.stsTokenManager.expirationTime;\n                        currentDate = new Date().getTime();\n                        expirationTimeout = tokenExpiration - currentDate;\n                        setTimeout( /*#__PURE__*/_asyncToGenerator( /*#__PURE__*/_regeneratorRuntime().mark(function _callee3() {\n                          return _regeneratorRuntime().wrap(function _callee3$(_context3) {\n                            while (1) switch (_context3.prev = _context3.next) {\n                              case 0:\n                                _context3.next = 2;\n                                return dispatch(\"fetchUser\");\n                              case 2:\n                              case \"end\":\n                                return _context3.stop();\n                            }\n                          }, _callee3);\n                        })), expirationTimeout);\n                        if (!router.currentRoute.meta.userCanAccess()) {\n                          router.push(\"/login\");\n                        }\n                      case 9:\n                      case \"end\":\n                        return _context4.stop();\n                    }\n                  }, _callee4);\n                }));\n                return function (_x) {\n                  return _ref4.apply(this, arguments);\n                };\n              }(), function (error) {\n                throw error;\n              });\n              return _context5.abrupt(\"return\", userUnsubscribe);\n            case 11:\n              throw new Error(\"User is not authenticated\");\n            case 12:\n              _context5.next = 18;\n              break;\n            case 14:\n              _context5.prev = 14;\n              _context5.t0 = _context5[\"catch\"](1);\n              dispatch(\"configureUser\", null);\n              throw _context5.t0;\n            case 18:\n            case \"end\":\n              return _context5.stop();\n          }\n        }, _callee5, null, [[1, 14]]);\n      }))();\n    }\n  },\n  modules: {}\n});","map":{"version":3,"names":["Vue","Vuex","getUserRol","Auth","Firestore","UsersDoc","router","use","Store","state","user","getters","isUserSignedIn","isUserAdmin","rol","mutations","setUser","actions","configureUser","_ref","username","_asyncToGenerator","_regeneratorRuntime","mark","_callee","commit","wrap","_callee$","_context","prev","next","sent","stop","logout","_ref2","_callee2","dispatch","_callee2$","_context2","signOut","getAuth","replace","fetchUser","_ref3","_callee5","firebaseUser","userUnsubscribe","_callee5$","_context5","currentUser","getIdToken","onSnapshot","uid","_ref4","_callee4","docSnap","firestoreUser","firestoreCopy","tokenExpiration","currentDate","expirationTimeout","_callee4$","_context4","data","_objectSpread","id","stsTokenManager","expirationTime","Date","getTime","setTimeout","_callee3","_callee3$","_context3","currentRoute","meta","userCanAccess","push","_x","apply","arguments","error","abrupt","Error","t0","modules"],"sources":["/Users/carlosmiret/Desktop/TallerAddalia/taller_vue_firebase/src/store/index.js"],"sourcesContent":["import Vue from \"vue\";\nimport Vuex from \"vuex\";\nimport { getUserRol } from \"@/services/users\";\nimport { Auth, Firestore, UsersDoc } from \"@/firebase-exports\";\n\nimport router from \"@/router\";\n\nVue.use(Vuex);\n\nexport default new Vuex.Store({\n  state: {\n    user: null,\n  },\n  getters: {\n    isUserSignedIn(state) {\n      return !!state.user;\n    },\n    isUserAdmin(state) {\n      if (state.user) {\n        return state.user.rol == \"admin\";\n      } else {\n        return false;\n      }\n    },\n  },\n  mutations: {\n    setUser(state, user) {\n      state.user = user;\n    },\n  },\n  actions: {\n    async configureUser({ commit }, username) {\n      const rol = await getUserRol();\n      commit(\"setUser\", { username: username, rol: rol });\n    },\n    async logout({ dispatch }) {\n      await Auth.signOut(Auth.getAuth());\n      router.replace(\"/login\");\n    },\n    // FetchUser\n    async fetchUser({ dispatch }) {\n      try {\n        const firebaseUser = await Auth.getAuth().currentUser;\n        Auth.getAuth().currentUser.getIdToken(false);\n        if (firebaseUser) {\n          var userUnsubscribe = Firestore.onSnapshot(\n            UsersDoc(firebaseUser.uid),\n            async (docSnap) => {\n              var firestoreUser = docSnap.data();\n              var firestoreCopy = {\n                ...firestoreUser,\n                id: firebaseUser.uid,\n              };\n              dispatch(\"configureUser\", firestoreCopy);\n\n              firestoreUser.id = firebaseUser.uid;\n              const tokenExpiration =\n                firebaseUser.stsTokenManager.expirationTime;\n              const currentDate = new Date().getTime();\n              const expirationTimeout = tokenExpiration - currentDate;\n              setTimeout(async () => {\n                await dispatch(\"fetchUser\");\n              }, expirationTimeout);\n              if (!router.currentRoute.meta.userCanAccess()) {\n                router.push(\"/login\");\n              }\n            },\n            (error) => {\n              throw error;\n            }\n          );\n          return userUnsubscribe;\n        } else {\n          throw new Error(\"User is not authenticated\");\n        }\n      } catch (err) {\n        dispatch(\"configureUser\", null);\n        throw err;\n      }\n    },\n  },\n  modules: {},\n});\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}